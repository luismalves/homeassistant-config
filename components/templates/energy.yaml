#####
# Custos energia
#
#####

- sensor:
    - name: "Monthly Energy Bill"
      unique_id: energy_bill_monthly
      device_class: monetary
      unit_of_measurement: "EUR"
      state: >
        {% set empty_kwh = 0 | float(0) %}
        {% set full_kwh = states('sensor.monthly_energy') | float(0) %}
        {% set empty_rate = states('input_number.energy_cost_per_kwh_empty_hours') | float(0) %}
        {% set full_rate = states('input_number.energy_cost_per_kwh_full_hours') | float(0) %}
        {% set discount = states('input_number.energy_discount') | float(0) / 100 %}
        {% set power_daily = states('input_number.energy_power_cost_per_day') | float(0) %}
        {% set access_daily = states('input_number.energy_access_cost_per_day') | float(0) %}
        {% set taxes = states('input_number.energy_taxes') | float(0) %}
        {% set last_reset = state_attr('sensor.monthly_energy', 'last_reset') | as_datetime | as_local %}
        {% set days = (now() - last_reset).days + 1 %}

        {% set energy_cost = (empty_kwh * empty_rate * (1 - discount)) + (full_kwh * full_rate * (1 - discount)) %}
        {% set energy_tax = (empty_kwh * 0.001) +  (full_kwh * 0.001) %}
        {% set daily_cost = days * (power_daily + access_daily) %}
        {% set total = (energy_cost + energy_tax + daily_cost + taxes) * 1.23 + 2.85 * 1.06 %}

        {{ total | round(2) }}

    - name: "Daily Energy Bill"
      unique_id: energy_bill_daily
      device_class: monetary
      unit_of_measurement: "EUR"
      state: >
        {% set empty_kwh = 0 | float(0) %}
        {% set full_kwh = states('sensor.daily_energy') | float(0) %}
        {% set empty_rate = states('input_number.energy_cost_per_kwh_empty_hours') | float(0) %}
        {% set full_rate = states('input_number.energy_cost_per_kwh_full_hours') | float(0) %}
        {% set discount = states('input_number.energy_discount') | float(0) / 100 %}
        {% set power_daily = states('input_number.energy_power_cost_per_day') | float(0) %}
        {% set access_daily = states('input_number.energy_access_cost_per_day') | float(0) %}

        {% set energy_cost = (empty_kwh * empty_rate * (1 - discount)) + (full_kwh * full_rate * (1 - discount)) %}
        {% set energy_tax = (empty_kwh * 0.001) +  (full_kwh * 0.001) %}
        {% set daily_cost = power_daily + access_daily %}
        {% set total = (energy_cost + energy_tax + daily_cost) * 1.23 %}

        {{ total | round(2) }}
