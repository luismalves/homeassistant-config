#####
# System Monitor templates
#
#####

- sensor:
    - name: "System Updates"
      unique_id: system_updates
      state: >
        {{
          expand(states.update)
          | selectattr('state', 'eq', 'on')
          | rejectattr('entity_id', 'in', integration_entities('mikrotik_router'))
          | rejectattr('entity_id', 'in', integration_entities('mqtt'))
          | map(attribute='entity_id')
          | list
          | count
          -
          states.update
          | selectattr('state', 'eq', 'on')
          | selectattr('attributes.model', 'eq', 'plugin')
          | map(attribute='entity_id')
          | list
          | count
        }}
      attributes:
        updates: >
          {{
            expand(states.update)
            | selectattr('state', 'eq', 'on')
            | rejectattr('entity_id', 'in', integration_entities('mikrotik_router'))
            | rejectattr('entity_id', 'in', integration_entities('mqtt'))
            | map(attribute='attributes.friendly_name')
            | list
          }}
        versions: >
          {{
            expand(states.update)
            | selectattr('state', 'eq', 'on')
            | rejectattr('entity_id', 'in', integration_entities('mikrotik_router'))
            | rejectattr('entity_id', 'in', integration_entities('mqtt'))
            | map(attribute='attributes.latest_version')
            | list
          }}

- sensor:
    - name: "Dashboard Updates"
      unique_id: dashboard_updates
      state: >
        {{
          states.update
          | selectattr('state', 'eq', 'on')
          | selectattr('attributes.model', 'eq', 'plugin')
          | map(attribute='entity_id')
          | list
          | count
        }}
      attributes:
        updates: >
          {{
            states.update
            | selectattr('state', 'eq', 'on')
            | selectattr('attributes.model', 'eq', 'plugin')
            | map(attribute='attributes.friendly_name')
            | list
          }}
        versions: >
          {{
            states.update
            | selectattr('state', 'eq', 'on')
            | selectattr('attributes.model', 'eq', 'plugin')
            | map(attribute='attributes.latest_version')
            | list
          }}

- sensor:
    - name: "Zigbee Updates"
      unique_id: zigbee_updates
      state: >
        {{
          states.update
          | selectattr('state', 'eq', 'on')
          | selectattr('entity_id', 'in', integration_entities('mqtt'))
          | map(attribute='entity_id')
          | list
          | count
        }}
      attributes:
        updates: >
          {{
            states.update
            | selectattr('state', 'eq', 'on')
            | selectattr('entity_id', 'in', integration_entities('mqtt'))
            | map(attribute='attributes.friendly_name')
            | list
          }}
        versions: >
          {{
            states.update
            | selectattr('state', 'eq', 'on')
            | selectattr('entity_id', 'in', integration_entities('mqtt'))
            | map(attribute='attributes.latest_version')
            | list
          }}
